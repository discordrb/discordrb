version: 2

# Common CI steps
dry:
  restore_bundle_cache: &restore_bundle_cache
    keys:
      - bundle-cache-v1-{{ checksum "ruby_version.txt" }}-{{ .Branch }}-{{ checksum "Gemfile" }}-{{ checksum "discordrb.gemspec" }}
      - bundle-cache-v1-{{ checksum "ruby_version.txt" }}-{{ .Branch }}
      - bundle-cache-v1-{{ checksum "ruby_version.txt" }}
  save_bundle_cache: &save_bundle_cache
    key: bundle-cache-v1-{{ checksum "ruby_version.txt" }}-{{ .Branch }}-{{ checksum "Gemfile" }}-{{ checksum "discordrb.gemspec" }}
    paths:
      - ./vendor/bundle
  run_tests: &run_tests
    # We shell out to git to compile our gemspec, additionally we need some
    # things from alpine:
    - run:
        name: Install OS packages
        command: apk add git build-base ruby-dev ruby-etc ruby-json
    - run:
        name: Ruby version
        command: ruby -v
    - checkout
    - run:
        name: Write ruby_version.txt for cache
        command: echo $RUBY_VERSION > ruby_version.txt
    - restore_cache: *restore_bundle_cache
    - run:
        name: Install dependencies
        command: bundle install --path vendor/bundle
    - save_cache: *save_bundle_cache
    - run:
        name: Run Rspec
        command: bundle exec rspec

jobs:
  test_ruby_24:
    docker:
      - image: ruby:2.4-alpine
    steps: *run_tests

  test_ruby_25:
    docker:
      - image: ruby:2.5-alpine
    steps: *run_tests

  test_ruby_26:
    docker:
      - image: ruby:2.6-alpine
    steps: *run_tests

  lints:
    docker:
      - image: ruby:2.5-alpine
    steps:
      # We shell out to git to compile our gemspec, additionally we need some
      # things from alpine:
      - run:
          name: Install OS packages
          command: apk add git build-base ruby-dev ruby-etc ruby-json
      - run:
          name: Ruby version
          command: ruby -v
      - checkout
      - run:
          name: Write ruby_version.txt for cache
          command: echo $RUBY_VERSION > ruby_version.txt
      - restore_cache: *restore_bundle_cache
      - run:
          name: Install dependencies
          command: bundle install --path vendor/bundle
      - save_cache: *save_bundle_cache
      - run:
          name: Run Rubocop
          command: bundle exec rubocop
      - run:
          name: Run YARD
          command: bundle exec yard

workflows:
  version: 2
  tests:
    jobs:
      - test_ruby_24
      - test_ruby_25
      - test_ruby_26
      - lints
